pipeline {
    agent any

    environment {
        AIRFLOW_USER = "admin"
        AIRFLOW_PASS = credentials('airflow-password-id') // Armazene a senha no Jenkins Credentials
    }

    stages {
        stage('Obter Token do Airflow') {
            steps {
                script {
                    def authResponse = httpRequest(
                        httpMode: 'POST',
                        url: 'http://localhost:9090/auth/token',
                        contentType: 'APPLICATION_JSON',
                        requestBody: """{
                          "username": "${AIRFLOW_USER}",
                          "password": "${AIRFLOW_PASS}"
                        }"""
                    )
                    def tokenJson = readJSON text: authResponse.content
                    env.AIRFLOW_TOKEN = tokenJson.token
                }
            }
        }

        stage('Acionar DAG no Airflow') {
            steps {
                script {
                    def dagResponse = httpRequest(
                        httpMode: 'POST',
                        url: 'http://localhost:9090/api/v1/dags/pipeline_ibge/dagRuns',
                        customHeaders: [[name: 'Authorization', value: "Bearer ${env.AIRFLOW_TOKEN}"]],
                        contentType: 'APPLICATION_JSON',
                        requestBody: '{"conf": {}}'
                    )
                    echo "Resposta do Airflow: ${dagResponse.status}"
                }
            }
        }
    }
}
